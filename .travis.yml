language: python
python:
  #- "2.6" # error: xml_declarations not available in write of lxml.etree
  #  (symptom: Undefined namespace prefix: b)
  - "2.7"
  - "3.2"
  - "3.3"
  - "3.4"
# Some required packages are not yet whitelisted, this doesn't work yet:
addons:
  apt:
    packages:
      - xsltproc       # https://github.com/travis-ci/travis-ci/issues/3944
      - jing           # https://github.com/travis-ci/travis-ci/issues/3945
# After the issues are closed, remove the code between {{{ and }}}:
# {{{
sudo: true
before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -y xsltproc jing
# }}}
install:
  - pip install coveralls pyflakes py3kwarn
  - SITEPACKAGES=$(pip --version | sed -n 's@.*from \([^ ]\+\) .*@\1@p')
  - echo 'import coverage; coverage.process_startup()' > $SITEPACKAGES/sitecustomize.py
  - printf '[run]\nparallel=True\n' > ~/coverage.cfg
script:
  - source env.sh
  - export COVERAGE_PROCESS_START=~/coverage.cfg
  - make test
  - find . -name '.coverage*' -exec mv -t . {} +
  - coverage combine
  # Test .gitignore for tests:
  - TMP=$(tempfile)
  - git ls-files . --exclude-standard --others | tee "$TMP"
  - if test -s "$TMP"; then false; else true; fi
  # Test if we .gitignore any tracked files:
  - git ls-files -i --exclude-standard | tee "$TMP"
  - if test -s "$TMP"; then false; else true; fi
  - pyflakes .
  - if [ "$TRAVIS_PYTHON_VERSION" = "2.7" ]; then py3kwarn .; fi
after_success:
  - coveralls
